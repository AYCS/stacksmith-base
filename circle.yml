machine:
  services:
  - docker
  environment:
    GCLOUD_PROJECT: stacksmith-images

dependencies:
  override:
  - docker info
  - gcloud version

test:
  override:
  - DEV_BUILD=1 make build

deployment:
  release:
    tag: /.*/
    commands:
    - >
      if [ -n $GCLOUD_SERVICE_KEY ]; then
        make $(echo $CIRCLE_TAG | cut -d'-' -f1 | sed -e 's/\//-/')
        echo $GCLOUD_SERVICE_KEY | base64 --decode > ${HOME}/gcloud-service-key.json
        gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json
        gcloud docker -- push gcr.io/$GCLOUD_PROJECT/$($CIRCLE_TAG | sed -e 's/\//:/')
      fi
